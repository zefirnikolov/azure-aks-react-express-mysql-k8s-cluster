# Dockerfile-reverse-proxy
FROM nginx:latest

# No need for openssl anymore since we just write provided certs
ENV CERT_DIR=/etc/nginx/certs
RUN mkdir -p "$CERT_DIR"

# Add a pre-start hook that ensures the certs exist.
# The official nginx entrypoint runs *.sh in /docker-entrypoint.d/ before starting nginx.
RUN set -eux; \
    mkdir -p /docker-entrypoint.d; \
    cat > /docker-entrypoint.d/09-ensure-certs.sh <<'SH'
#!/bin/sh
set -e

CERT_DIR="${CERT_DIR:-/etc/nginx/certs}"
FULLCHAIN="${CERT_DIR}/fullchain.pem"
PRIVKEY="${CERT_DIR}/privkey.pem"

# If either file is missing/empty, write the bundled dev cert/key
if [ ! -s "$FULLCHAIN" ] || [ ! -s "$PRIVKEY" ]; then
  echo "[reverse-proxy] No TLS certs found in $CERT_DIR. Writing bundled development certs..."
  mkdir -p "$CERT_DIR"

  # --- fullchain.pem ---
  cat > "$FULLCHAIN" <<'PEM'
-----BEGIN CERTIFICATE-----
MIIBHjCBxQIUchEShuE3aeurCEhpKqg6glbepUowCgYIKoZIzj0EAwIwEjEQMA4G
A1UEAwwHYmFja2VuZDAeFw0yNDA0MjIwNjI5NTFaFw0yNTA0MjIwNjI5NTFaMBIx
EDAOBgNVBAMMB2JhY2tlbmQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASLfbPZ
47AweA2FxYTwb3D433Or3MbmzejjGxbfUiQrOwny1t5cisPNXUITKk450hNexxgO
O0UfUDSIyxMhtP0qMAoGCCqGSM49BAMCA0gAMEUCID258OCaZsf0gWOd59I+6Fzn
G49RBIhF2vIWW0qpGeV4AiEA+1UUvJWyaOHsSrEx3TBaN2SDg0XH0nWqYAST6kZD
WNg=
-----END CERTIFICATE-----
PEM

  # --- privkey.pem ---
  cat > "$PRIVKEY" <<'PEM'
-----BEGIN EC PARAMETERS-----
BggqhkjOPQMBBw==
-----END EC PARAMETERS-----
-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIP43Wr06R+0T8qKhJz/zeVa0z0a7pSTtLWoEjJ7Qbt7woAoGCCqGSM49
AwEHoUQDQgAEi32z2eOwMHgNhcWE8G9w+N9zq9zG5s3o4xsW31IkKzsJ8tbeXIrD
zV1CEypOOdITXscYDjtFH1A0iMsTIbT9Kg==
-----END EC PRIVATE KEY-----
PEM

  # Permissions
  chmod 600 "$PRIVKEY"
  chmod 644 "$FULLCHAIN"

  echo "[reverse-proxy] Wrote $FULLCHAIN and $PRIVKEY"
else
  echo "[reverse-proxy] TLS certs already present. Skipping."
fi
SH
RUN chmod +x /docker-entrypoint.d/09-ensure-certs.sh
